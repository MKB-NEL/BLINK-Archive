<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase - Blink Archive</title>
    <style>
        /* ... (keep all existing styles the same) ... */

        /* Add new styles for minimum amount warning */
        .minimum-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .minimum-warning h4 {
            margin-bottom: 10px;
            color: #856404;
        }

        .test-mode-badge {
            background: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo" onclick="goHome()">BLINK ARCHIVE</div>
            <div></div>
        </div>
    </header>

    <div class="main-container">
        <div class="product-container">
            <!-- Product Details -->
            <div class="product-details">
                <div class="product-gallery">
                    <div class="main-image" id="mainImage">
                        <img src="" alt="Product image" id="mainImageSrc">
                    </div>
                    <div class="image-thumbnails" id="imageThumbnails"></div>
                </div>

                <div class="product-info">
                    <h1 class="product-title" id="productTitle">Loading...</h1>
                    <p class="product-description" id="productDescription"></p>
                    
                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">Last Updated</span>
                            <span class="meta-value" id="lastUpdated">Loading...</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Views</span>
                            <span class="meta-value" id="productViews">0</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">File Type</span>
                            <span class="meta-value">HTML/CSS/JS</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Area - Dynamic Content -->
            <div class="purchase-section">
                <div class="price-section">
                    <div class="price" id="productPrice">Loading...</div>
                    <div class="currency">BTC</div>
                </div>

                <div class="action-area" id="actionArea">
                    <!-- Content will be dynamically populated -->
                </div>

                <div class="security-badges">
                    <div class="badge">
                        <i class="fas fa-shield-alt" style="color: #00a000;"></i>
                        <span>Secure Crypto Payment</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-lock" style="color: #1a73e8;"></i>
                        <span>Encrypted File Delivery</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-clock" style="color: #ff6b00;"></i>
                        <span>Instant Digital Download</span>
                    </div>
                </div>
            </div>

            <!-- Invoice Section -->
            <div class="invoice-section" id="invoiceSection">
                <div class="invoice-header">
                    <h2 class="invoice-title">Payment Invoice</h2>
                    <p class="invoice-subtitle">Send exact amount to complete purchase</p>
                    <div class="test-mode-badge">
                        <i class="fas fa-vial"></i> TEST MODE
                    </div>
                </div>

                <div class="minimum-warning" id="minimumWarning" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Minimum Amount Notice</h4>
                    <p>Your product price is below the minimum payment amount. Using demo mode for testing.</p>
                    <p><strong>In production, ensure prices meet payment gateway minimums.</strong></p>
                </div>

                <div class="invoice-details">
                    <div class="invoice-item">
                        <span class="invoice-label">Product</span>
                        <span class="invoice-value" id="invoiceProduct">-</span>
                    </div>
                    <div class="invoice-item">
                        <span class="invoice-label">Order ID</span>
                        <span class="invoice-value" id="invoiceOrderId">-</span>
                    </div>
                    <div class="invoice-item">
                        <span class="invoice-label">Amount Due</span>
                        <span class="invoice-value" id="invoiceAmount">-</span>
                    </div>
                    <div class="invoice-item">
                        <span class="invoice-label">Payment Status</span>
                        <span class="invoice-value" id="invoiceStatus">Pending</span>
                    </div>
                </div>

                <div class="qr-code">
                    <div class="qr-placeholder" id="qrCode">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-qrcode" style="font-size: 3rem; color: #ccc; margin-bottom: 10px;"></i>
                            <div style="color: #666; font-size: 0.9rem;">Demo Payment Interface</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666;">For demo purposes only</p>
                </div>

                <div class="payment-address">
                    <div class="invoice-label">Demo Payment Address</div>
                    <div class="address" id="paymentAddress">bc1qdemoaddressforblinkarchive123456</div>
                    <button class="copy-btn" id="copyAddressBtn">
                        <i class="fas fa-copy"></i>
                        Copy Address
                    </button>
                </div>

                <div class="payment-status" id="paymentStatus">
                    <div class="status-loading">
                        <div class="spinner"></div>
                        <span>Waiting for payment confirmation...</span>
                    </div>
                </div>

                <!-- Demo Payment Controls -->
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border: 1px dashed #ccc;">
                    <h4 style="margin-bottom: 15px; color: #666;">Demo Controls</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                        Simulate payment for testing purposes
                    </p>
                    <button class="purchase-btn" id="simulatePaymentBtn" style="background: #17a2b8; border-color: #17a2b8;">
                        <i class="fas fa-bolt"></i>
                        Simulate Payment
                    </button>
                </div>
            </div>

            <!-- Download Section -->
            <div class="download-section" id="downloadSection">
                <div class="download-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="download-title">Payment Confirmed!</h2>
                <p class="download-subtitle">Your digital product is ready for download</p>
                
                <a href="#" class="download-btn" id="downloadBtn" target="_blank">
                    <i class="fas fa-download"></i>
                    Download Now
                </a>
                
                <div class="timer" id="downloadTimer">
                    <i class="fas fa-clock"></i> Link expires in 24 hours
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border: 1px solid #b3d9ff;">
                    <h4 style="color: #0066cc; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Download Instructions</h4>
                    <p style="color: #0066cc; font-size: 0.9rem; margin: 0;">
                        Your purchase has been recorded. You can also access this file anytime from your <a href="settings.html" style="color: #004499; font-weight: 600;">Account Settings</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, doc, updateDoc, increment, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzhfXHrY48d2DhlWwhSTxMHl04USLjtz0",
            authDomain: "blink-archive.firebaseapp.com",
            projectId: "blink-archive",
            storageBucket: "blink-archive.firebasestorage.app",
            messagingSenderId: "524384519627",
            appId: "1:524384519627:web:10fc00ae09ce91a573a24e",
            measurementId: "G-3C18W3NH1V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // NOWPayments API Configuration
        const NOWPAYMENTS_API_KEY = '2VZM2CZ-S174TD3-K3232BJ-Z8Y9XH0';
        const NOWPAYMENTS_BASE_URL = 'https://api.nowpayments.io/v1';
        const MINIMUM_BTC_AMOUNT = 0.0005; // NOWPayments minimum is around 0.0005 BTC

        let currentUser = null;
        let currentProduct = null;
        let currentOrder = null;
        let paymentCheckInterval = null;
        let isDemoMode = false;

        // Initialize product page
        async function initializeProductPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                alert('Product ID not found');
                goHome();
                return;
            }

            // Monitor authentication state
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                await loadProduct(productId);
                setupEventListeners();
                checkExistingOrder();
            });
        }

        // Check for existing order for this user and product
        async function checkExistingOrder() {
            if (!currentUser || !currentProduct) return;

            try {
                const ordersQuery = query(
                    collection(db, "orders"), 
                    where("userId", "==", currentUser.uid),
                    where("productId", "==", currentProduct.id)
                );
                
                const querySnapshot = await getDocs(ordersQuery);
                
                if (!querySnapshot.empty) {
                    const orderDoc = querySnapshot.docs[0];
                    currentOrder = {
                        id: orderDoc.id,
                        ...orderDoc.data()
                    };
                    
                    // Set up real-time listener for order status changes
                    setupOrderListener(orderDoc.id);
                    
                    if (currentOrder.status === 'paid') {
                        showDownloadSection(currentOrder.downloadLink);
                    } else if (currentOrder.status === 'unpaid') {
                        showInvoiceSection(currentOrder);
                        if (currentOrder.paymentId && !currentOrder.paymentId.startsWith('demo-')) {
                            startPaymentChecking(currentOrder.paymentId);
                        }
                    }
                } else {
                    showPurchaseButton();
                }
                
            } catch (error) {
                console.error('Error checking existing order:', error);
                showPurchaseButton();
            }
        }

        // Set up real-time listener for order status
        function setupOrderListener(orderId) {
            const orderRef = doc(db, "orders", orderId);
            
            onSnapshot(orderRef, (doc) => {
                if (doc.exists()) {
                    const orderData = doc.data();
                    currentOrder = { id: doc.id, ...orderData };
                    
                    if (orderData.status === 'paid') {
                        if (paymentCheckInterval) {
                            clearInterval(paymentCheckInterval);
                        }
                        showDownloadSection(orderData.downloadLink);
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('copyAddressBtn').addEventListener('click', copyAddress);
            document.getElementById('simulatePaymentBtn').addEventListener('click', simulatePayment);
        }

        // Load product details from Firebase
        async function loadProduct(productId) {
            try {
                const q = query(collection(db, "products"), where("__name__", "==", productId));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    alert('Product not found');
                    goHome();
                    return;
                }

                const productDoc = querySnapshot.docs[0];
                currentProduct = {
                    id: productDoc.id,
                    ...productDoc.data()
                };

                displayProductDetails();
                
                // Increment view count
                await updateDoc(doc(db, "products", productId), {
                    views: increment(1)
                });

            } catch (error) {
                console.error('Error loading product:', error);
                alert('Error loading product details');
            }
        }

        // Display product details
        function displayProductDetails() {
            if (!currentProduct) return;

            // Set basic product info
            document.getElementById('productTitle').textContent = currentProduct.name;
            document.getElementById('productDescription').textContent = currentProduct.description;
            
            // Format and display price with color coding
            const priceElement = document.getElementById('productPrice');
            priceElement.textContent = currentProduct.price + ' BTC';
            
            if (currentProduct.price > 0.1) {
                priceElement.className = 'price price-high';
            } else if (currentProduct.price >= 0.009) {
                priceElement.className = 'price price-medium';
            } else {
                priceElement.className = 'price price-low';
            }

            // Display last updated date
            const lastUpdated = currentProduct.last_updated?.toDate() || currentProduct.created_at?.toDate() || new Date();
            document.getElementById('lastUpdated').textContent = lastUpdated.toLocaleDateString();
            
            // Display views
            document.getElementById('productViews').textContent = currentProduct.views || 0;

            // Display images
            displayProductImages();
        }

        // Display product images
        function displayProductImages() {
            const mainImage = document.getElementById('mainImageSrc');
            const thumbnailsContainer = document.getElementById('imageThumbnails');

            if (currentProduct.images && currentProduct.images.length > 0) {
                // Set main image
                mainImage.src = currentProduct.images[0];
                
                // Create thumbnails
                thumbnailsContainer.innerHTML = currentProduct.images.map((image, index) => `
                    <div class="thumbnail ${index === 0 ? 'active' : ''}" data-image="${image}">
                        <img src="${image}" alt="Thumbnail ${index + 1}">
                    </div>
                `).join('');

                // Add click listeners to thumbnails
                document.querySelectorAll('.thumbnail').forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        const imageSrc = this.getAttribute('data-image');
                        changeMainImage(imageSrc, this);
                    });
                });
            } else {
                // Use placeholder if no images
                mainImage.src = 'https://via.placeholder.com/600x400/f5f5f5/666?text=No+Image';
                thumbnailsContainer.innerHTML = '';
            }
        }

        // Change main image when thumbnail is clicked
        function changeMainImage(imageSrc, element) {
            document.getElementById('mainImageSrc').src = imageSrc;
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Show purchase button or auth required message
        function showPurchaseButton() {
            const actionArea = document.getElementById('actionArea');
            
            if (!currentUser) {
                // User not logged in
                actionArea.innerHTML = `
                    <div class="auth-required">
                        <h3>Sign In Required</h3>
                        <p>You need to be signed in to purchase this product</p>
                        <button class="auth-btn" onclick="redirectToAuth()">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In to Purchase
                        </button>
                    </div>
                `;
            } else {
                // Check if price meets minimum requirements
                if (currentProduct.price < MINIMUM_BTC_AMOUNT) {
                    actionArea.innerHTML = `
                        <div class="minimum-warning">
                            <h4><i class="fas fa-exclamation-triangle"></i> Demo Mode</h4>
                            <p>Product price is below payment gateway minimum. Using demo mode.</p>
                        </div>
                        <button class="purchase-btn" id="purchaseBtn">
                            <i class="fas fa-shopping-cart"></i>
                            Purchase in Demo Mode
                        </button>
                    `;
                } else {
                    actionArea.innerHTML = `
                        <button class="purchase-btn" id="purchaseBtn">
                            <i class="fas fa-shopping-cart"></i>
                            Purchase Now
                        </button>
                    `;
                }
                
                document.getElementById('purchaseBtn').addEventListener('click', initiatePurchase);
            }
        }

        // Redirect to auth
        window.redirectToAuth = function() {
            window.location.href = 'index.html#auth';
        };

        // Initialize purchase process
        async function initiatePurchase() {
            if (!currentProduct || !currentUser) return;

            const purchaseBtn = document.getElementById('purchaseBtn');
            purchaseBtn.disabled = true;
            purchaseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';

            try {
                // Check if we need to use demo mode
                isDemoMode = currentProduct.price < MINIMUM_BTC_AMOUNT;
                
                let payment;
                if (isDemoMode) {
                    payment = createDemoPayment();
                } else {
                    payment = await createNowPaymentsPayment();
                }
                
                // Create order in Firebase
                const orderData = {
                    userId: currentUser.uid,
                    productId: currentProduct.id,
                    productName: currentProduct.name,
                    price: currentProduct.price,
                    currency: 'BTC',
                    status: 'unpaid',
                    paymentId: payment.id,
                    paymentAddress: payment.pay_address,
                    payAmount: payment.pay_amount,
                    createdAt: new Date().toISOString(),
                    downloadLink: currentProduct.download_link,
                    isDemo: isDemoMode
                };

                const docRef = await addDoc(collection(db, "orders"), orderData);
                
                currentOrder = {
                    id: docRef.id,
                    ...orderData
                };

                // Set up real-time listener for this order
                setupOrderListener(docRef.id);
                
                // Show invoice section
                showInvoiceSection(currentOrder);
                
                // Only start payment checking for real payments
                if (!isDemoMode && payment.id && !payment.id.startsWith('demo-')) {
                    startPaymentChecking(payment.id);
                }

            } catch (error) {
                console.error('Error initiating purchase:', error);
                alert('Error creating payment. Please try again.');
                purchaseBtn.disabled = false;
                purchaseBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Purchase Now';
            }
        }

        // Create payment with NOWPayments API
        async function createNowPaymentsPayment() {
            try {
                const paymentData = {
                    price_amount: parseFloat(currentProduct.price),
                    price_currency: 'btc',
                    pay_currency: 'btc',
                    order_id: `blink-${Date.now()}-${currentProduct.id}`,
                    order_description: currentProduct.name,
                    ipn_callback_url: 'https://your-webhook-url.com/nowpayments',
                    success_url: window.location.href,
                    cancel_url: window.location.href
                };

                console.log('Creating NOWPayments payment:', paymentData);

                const response = await fetch(`${NOWPAYMENTS_BASE_URL}/payment`, {
                    method: 'POST',
                    headers: {
                        'x-api-key': NOWPAYMENTS_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('NOWPayments API error:', errorData);
                    
                    // If amount is too small, fall back to demo mode
                    if (errorData.code === 'AMOUNT_MINIMAL_ERROR') {
                        isDemoMode = true;
                        return createDemoPayment();
                    }
                    
                    throw new Error(`NOWPayments API error: ${JSON.stringify(errorData)}`);
                }

                const payment = await response.json();
                console.log('NOWPayments payment created:', payment);
                return payment;

            } catch (error) {
                console.error('Error creating NOWPayments payment:', error);
                // Fall back to demo mode
                isDemoMode = true;
                return createDemoPayment();
            }
        }

        // Create demo payment for testing
        function createDemoPayment() {
            return {
                id: 'demo-' + Date.now(),
                pay_address: 'bc1qdemoaddressforblinkarchive123456',
                pay_amount: currentProduct.price.toFixed(8),
                order_id: `blink-demo-${Date.now()}-${currentProduct.id}`
            };
        }

        // Show invoice section
        function showInvoiceSection(order) {
            // Hide purchase section, show invoice section
            document.querySelector('.purchase-section').style.display = 'none';
            document.getElementById('invoiceSection').style.display = 'block';

            // Show minimum warning if in demo mode
            if (order.isDemo) {
                document.getElementById('minimumWarning').style.display = 'block';
            }

            // Populate invoice details
            document.getElementById('invoiceProduct').textContent = order.productName;
            document.getElementById('invoiceOrderId').textContent = order.paymentId;
            document.getElementById('invoiceAmount').textContent = order.payAmount + ' BTC';
            document.getElementById('paymentAddress').textContent = order.paymentAddress;
            document.getElementById('invoiceStatus').textContent = order.isDemo ? 'Demo Mode' : 'Pending';

            // Show/hide demo controls
            document.getElementById('simulatePaymentBtn').style.display = order.isDemo ? 'block' : 'none';
        }

        // Simulate payment for demo mode
        async function simulatePayment() {
            const simulateBtn = document.getElementById('simulatePaymentBtn');
            simulateBtn.disabled = true;
            simulateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            // Simulate processing delay
            setTimeout(async () => {
                await confirmPayment();
            }, 2000);
        }

        // Start checking payment status with NOWPayments API
        function startPaymentChecking(paymentId) {
            paymentCheckInterval = setInterval(async () => {
                await checkNowPaymentsStatus(paymentId);
            }, 15000); // Check every 15 seconds

            // Initial check
            checkNowPaymentsStatus(paymentId);
        }

        // Check payment status with NOWPayments API
        async function checkNowPaymentsStatus(paymentId) {
            if (paymentId.startsWith('demo-')) return;

            try {
                const response = await fetch(`${NOWPAYMENTS_BASE_URL}/payment/${paymentId}`, {
                    headers: {
                        'x-api-key': NOWPAYMENTS_API_KEY
                    }
                });

                if (response.ok) {
                    const paymentStatus = await response.json();
                    console.log('Payment status:', paymentStatus);
                    
                    if (paymentStatus.payment_status === 'finished' || paymentStatus.payment_status === 'confirmed') {
                        await confirmPayment();
                    }
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
            }
        }

        // Confirm payment and update order
        async function confirmPayment() {
            if (!currentOrder) return;

            try {
                // Update order status in Firebase
                await updateDoc(doc(db, "orders", currentOrder.id), {
                    status: 'paid',
                    paidAt: new Date().toISOString()
                });

                // Update local order
                currentOrder.status = 'paid';

                // Stop payment checking
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                }

                // The download section will be shown automatically via the real-time listener

            } catch (error) {
                console.error('Error confirming payment:', error);
            }
        }

        // Show download section
        function showDownloadSection(downloadUrl) {
            document.querySelector('.purchase-section').style.display = 'none';
            document.getElementById('invoiceSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'block';

            // Set download link
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.href = downloadUrl;
        }

        // Copy payment address to clipboard
        async function copyAddress() {
            const address = document.getElementById('paymentAddress').textContent;
            try {
                await navigator.clipboard.writeText(address);
                
                const copyBtn = document.getElementById('copyAddressBtn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.style.background = '#00a000';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.background = '';
                }, 2000);
                
            } catch (error) {
                console.error('Failed to copy address:', error);
                alert('Failed to copy address. Please copy manually.');
            }
        }

        // Navigation functions
        window.goHome = function() {
            window.location.href = 'index.html';
        };

        window.goBack = function() {
            window.history.back();
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', initializeProductPage);
    </script>
</body>
</html>
